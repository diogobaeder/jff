// jQuery Form Framework - http://sourceforge.net/projects/jff - Release under GPL and MIT
(function($){Array.prototype.indexesOf=function(obj){var foundItems=new Array();for(var i=0;i<this.length;i++){if(obj==this[i])foundItems.push(i);}
return foundItems;};Array.prototype.pull=function(index){return this.splice(index,1);};Array.prototype.remove=function(obj){var index=this.indexOf(obj);if(index>=0)this.pull(index);};Array.prototype.removeAll=function(obj){this.filter(function(element,index,array){return(element!=obj);});return this;};String.prototype.ucfirst=function(){var first=this.substring(0,1).toUpperCase();var rest=this.substring(1,this.length);return first+rest;};String.prototype.uToCamel=function(){return this.split('_').map(function(word){return word.ucfirst();}).join('');};String.prototype.filtered=function(){if(arguments.length==0)return this;var tmp=String(this);$.makeArray(arguments).forEach(function(filter){tmp=tmp.split(filter).join('');});return tmp;};window.jFF=function(message,focusAndBlur){return new jFF.core.FieldManager(message,focusAndBlur);};window.jFFField=function(jObj,message,focusAndBlur){return new jFF.core.Field(jObj,message,focusAndBlur);};window.jFFCompositeField=function(message,minValid,focusAndBlur){return new jFF.core.CompositeField(message,minValid,focusAndBlur);};window.jFFBehaviour=function(){var args=(arguments.length>1)?$.makeArray(arguments).slice(1,arguments.length):[];return jFF.core.Factories.behaviour(arguments[0],args);};jFF.core=new Object();jFF.core.FieldManager=function(message,focusAndBlur){var objRef=this;this.fields=new Array();this.handlers=new Array();this.message=message;this.focusAndBlur=focusAndBlur;this.valid=true;this.bypass=false;this.defaultValid=true;this.enable=function(){objRef.bypass=false;return objRef;}
this.disable=function(defaultValid){objRef.bypass=true;objRef.defaultValid=Boolean(defaultValid);return objRef;}
this.forEach=function(callback){objRef.fields.forEach(callback);return objRef;};this.handler=function(){if(arguments.length==1&&typeof arguments[0]!='string'){objRef.handlers.push(arguments[0]);}
else{var args=(arguments.length>1)?$.makeArray(arguments).slice(1,arguments.length):[];objRef.handlers.push(jFF.core.Factories.handler(arguments[0],args));}
return objRef;};this.validate=function(callback,toggleErrors){objRef.valid=objRef.check(toggleErrors);if(callback)
callback(objRef.valid);if(toggleErrors&&!objRef.valid)objRef.showErrors();else if(toggleErrors&&objRef.valid)objRef.hideErrors();return objRef;};this.check=function(toggleErrors){if(objRef.bypass)return objRef.defaultValid;var allValid=true;objRef.fields.forEach(function(field){field.validate(function(fieldValid){if(!fieldValid){allValid=false;}},toggleErrors);});return allValid;};this.showErrors=function(){if(objRef.handlers.length>0){objRef.handlers.forEach(function(handler){handler.show(objRef);});}};this.hideErrors=function(){if(objRef.handlers.length>0){objRef.handlers.forEach(function(handler){handler.hide(objRef);});}};this.add=function(){objRef.fields.push.apply(objRef.fields,arguments);$.makeArray(arguments).forEach(function(field){field.managers.push(objRef);if(objRef.focusAndBlur&&field.focusAndBlur){field.jObj.not(':checkbox,:radio').bind('focus.jFF',function(){objRef.hideErrors();});field.jObj.not(':checkbox,:radio').bind('blur.jFF',function(){objRef.validate(null,true);});}});return objRef;};this.remove=function(field){objRef.fields.removeAll(field);return objRef;};this.pull=function(index){return objRef.fields.pull(index);};this.simpleButtonForm=function(jButton,jForm,showErrors){jButton.bind('click.jFF',function(event){event.preventDefault();event.stopPropagation();if(objRef.validate(null,showErrors).valid){jForm.submit();}});return objRef;};};jFF.core.Field=function(jObj,message,focusAndBlur){var objRef=this;this.managers=new Array();this.validators=new Array();this.handlers=new Array();this.jObj=jObj;this.message=message;this.focusAndBlur=focusAndBlur;if(objRef.focusAndBlur){objRef.jObj.not(':checkbox,:radio').bind('focus.jFF',function(){objRef.hideErrors();});objRef.jObj.not(':checkbox,:radio').bind('blur.jFF',function(){objRef.validate(null,true);});}
this.valid=true;this.bypass=false;this.defaultValid=true;this.enable=function(){objRef.bypass=false;return objRef;}
this.disable=function(defaultValid){objRef.bypass=true;objRef.defaultValid=Boolean(defaultValid);return objRef;}
this.validator=function(){if(arguments.length==1&&typeof arguments[0]!='string'){objRef.validators.push(arguments[0]);}
else{var args=(arguments.length>1)?$.makeArray(arguments).slice(1,arguments.length):[];objRef.validators.push(jFF.core.Factories.validator(arguments[0],args));}
return objRef;};this.handler=function(){if(arguments.length==1&&typeof arguments[0]!='string'){objRef.handlers.push(arguments[0]);}
else{var args=(arguments.length>1)?$.makeArray(arguments).slice(1,arguments.length):[];objRef.handlers.push(jFF.core.Factories.handler(arguments[0],args));}
return objRef;};this.validate=function(callback,toggleErrors){objRef.valid=objRef.check(toggleErrors);if(toggleErrors&&!objRef.valid)objRef.showErrors();else if(toggleErrors&&objRef.valid)objRef.hideErrors();if(callback)callback(objRef.valid);return objRef;};this.check=function(toggleErrors){if(objRef.bypass)return objRef.defaultValid;var allValid=true;objRef.validators.forEach(function(validator){var valid=validator.validate(objRef);if(!valid){allValid=false;}});return allValid;};this.showErrors=function(){if(objRef.handlers.length>0){objRef.handlers.forEach(function(element){element.show(objRef);});}};this.hideErrors=function(){if(objRef.handlers.length>0){objRef.handlers.forEach(function(element){element.hide(objRef);});}};this.manager=function(fieldManager){fieldManager.add(objRef);return objRef;};this.removeManager=function(fieldManager){fieldManager.remove(objRef);return objRef;};};jFF.core.CompositeField=function(message,minValid,focusAndBlur){var objRef=this;this.managers=new Array();this.handlers=new Array();this.fields=new Array();this.jObj=null;this.message=message;this.minValid=minValid;this.focusAndBlur=focusAndBlur;this.valid=true;this.bypass=false;this.defaultValid=true;this.enable=function(){objRef.bypass=false;return objRef;}
this.disable=function(defaultValid){objRef.bypass=true;objRef.defaultValid=Boolean(defaultValid);return objRef;}
this.handler=function(){if(arguments.length==1&&typeof arguments[0]!='string'){objRef.handlers.push(arguments[0]);}
else{var args=(arguments.length>1)?$.makeArray(arguments).slice(1,arguments.length):[];objRef.handlers.push(jFF.core.Factories.handler(arguments[0],args));}
return objRef;};this.validate=function(callback,toggleErrors){objRef.valid=objRef.check(toggleErrors);if(callback)
callback(objRef.valid);if(toggleErrors&&!objRef.valid)objRef.showErrors();else if(toggleErrors&&objRef.valid)objRef.hideErrors();return objRef;};this.check=function(toggleErrors){if(objRef.bypass)return objRef.defaultValid;var valid=0;objRef.fields.forEach(function(field){field.validate(function(fieldValid){if(fieldValid)valid++;},toggleErrors);});return valid>=objRef.minValid;};this.showErrors=function(){if(objRef.handlers.length>0){objRef.handlers.forEach(function(element){element.show(objRef);});}};this.hideErrors=function(){if(objRef.handlers.length>0){objRef.handlers.forEach(function(element){element.hide(objRef);});}};this.manager=function(fieldManager){fieldManager.add(objRef);return objRef;};this.removeManager=function(fieldManager){fieldManager.remove(objRef);return objRef;};this.add=function(){objRef.fields.push.apply(objRef.fields,arguments);$.makeArray(arguments).forEach(function(field){if(objRef.jObj)objRef.jObj.add(field.jObj);else objRef.jObj=field.jObj;if(objRef.focusAndBlur&&field.focusAndBlur){field.jObj.not(':checkbox,:radio').bind('focus.jFF',function(){objRef.hideErrors();});field.jObj.not(':checkbox,:radio').bind('blur.jFF',function(){objRef.validate(null,true);});}});return objRef;};this.remove=function(field){objRef.fields.removeAll(field);return objRef;};this.pull=function(index){return objRef.fields.pull(index);};};jFF.core.Factories={handler:function(name,options){var klass=jFF.errorhandlers[name.uToCamel()];return new klass(options);},validator:function(name,options){var klass=jFF.validators[name.uToCamel()];return new klass(options);},behaviour:function(name,options){var klass=jFF.behaviours[name.uToCamel()];return new klass(options);}};jFF.validators=new Object();jFF.errorhandlers=new Object();jFF.behaviours=new Object();jFF.validators.NumChecked=function(options){var objRef=this;this.min=options[0];this.max=options[1];this.validate=function(field){var checked=field.jObj.filter(':checked').add(field.jObj.find(':checked'));if(!checked){return false;}
if((objRef.min===null&&checked.length<=objRef.max)||(objRef.max===null&&checked.length>=objRef.min)||(checked.length>=objRef.min&&checked.length<=objRef.max)){return true;}
return false;};};jFF.validators.MaxChecked=function(max){return new jFF.validators.NumChecked([null,max]);};jFF.validators.MinChecked=function(min){return new jFF.validators.NumChecked([min,null]);};jFF.validators.HasText=function(options){this.validate=function(field){return Boolean(field.jObj.val&&field.jObj.val());};};jFF.validators.HasValue=function(options){this.validate=function(field){return Boolean(field.jObj.val&&field.jObj.val());};};jFF.validators.SelectedHasValue=function(options){this.validate=function(field){var jSelected=field.jObj.filter(':selected').add(field.jObj.find(':selected'));return Boolean(jSelected.val&&jSelected.val());};};jFF.validators.NumChars=function(options){var objRef=this;this.min=options[0];this.max=options[1];this.validate=function(field){var textFieldSelectors=':text,:password,textarea';var chars=field.jObj.filter(textFieldSelectors).add(field.jObj.find(textFieldSelectors)).val();if(!chars){return false;}
if((objRef.min===null&&chars.length<=objRef.max)||(objRef.max===null&&chars.length>=objRef.min)||(chars.length>=objRef.min&&chars.length<=objRef.max)){return true;}
return false;};};jFF.validators.MaxChars=function(max){return new jFF.validators.NumChars([null,max]);};jFF.validators.MinChars=function(min){return new jFF.validators.NumChars([min,null]);};jFF.validators.RegEx=function(options){var objRef=this;this.pattern=options[0];this.validate=function(field){var fieldValue=field.jObj.val&&field.jObj.val();return fieldValue&&objRef.pattern.test(fieldValue);};};jFF.validators.Email=function(options){var emailPattern=/^[\w-\.]+@([\w-]+\.)+[\w-]+$/;return new jFF.validators.RegEx([emailPattern]);};jFF.validators.NumSelected=function(options){var objRef=this;this.min=options[0];this.max=options[1];this.validate=function(field){var selected=field.jObj.filter(':selected').add(field.jObj.find(':selected'));if(!selected){return false;}
if((objRef.min===null&&selected.length<=objRef.max)||(objRef.max===null&&selected.length>=objRef.min)||(selected.length>=objRef.min&&selected.length<=objRef.max)){return true;}
return false;};};jFF.validators.MaxSelected=function(max){return new jFF.validators.NumSelected([null,max]);};jFF.validators.MinSelected=function(min){return new jFF.validators.NumSelected([min,null]);};jFF.validators.Custom=function(options){var objRef=this;this.callback=options[0];this.validate=function(field){return objRef.callback(field);};};jFF.errorhandlers.Alert=function(options){var objRef=this;this.alertText=options[0];this.show=function(subject){alert(objRef.alertText);};this.hide=function(subject){};};jFF.errorhandlers.Append=function(options){var objRef=this;this.message=options[0];this.jContainer=options[1];this.errorVisible=false;var jMessage=(objRef.message.jquery)?objRef.message:$('<span>'+objRef.message+'</span>');this.show=function(subject){if(!objRef.errorVisible){objRef.jContainer.append(jMessage);objRef.errorVisible=true;}};this.hide=function(subject){if(objRef.errorVisible){jMessage.remove();objRef.errorVisible=false;}};};jFF.errorhandlers.Console=function(options){var objRef=this;this.alertText=options[0];this.show=function(subject){console.debug(objRef.alertText);};this.hide=function(subject){};};jFF.errorhandlers.ManagerFieldsAppend=function(options){var objRef=this;this.mainWrapperText=options[0];this.fieldWrapperText=options[1];this.jContainer=options[2];this.jContent=null;this.show=function(subject){var summedText='';subject.fields.forEach(function(element){if(!element.valid){summedText+=objRef.fieldWrapperText.replace(/%s/g,element.message);}});var wholeText=$(objRef.mainWrapperText.replace(/%s/g,summedText));if(objRef.jContent){objRef.jContent.remove();}
objRef.jContent=wholeText;objRef.jContainer.append(objRef.jContent);};this.hide=function(subject){if(objRef.jContent){objRef.jContent.remove();}};};jFF.errorhandlers.Custom=function(options){var objRef=this;this.callback=options[0];this.show=function(subject){objRef.callback(subject,true);};this.hide=function(subject){objRef.callback(subject,false);};};jFF.errorhandlers.ToggleVisibility=function(options){var objRef=this;this.objects=options[0];this.toggleMode=options[1];this.errorVisible=false;if(objRef.toggleMode=='hide_only'){this.errorVisible=this.objects.is(':visible');}
this.show=function(subject){if(!objRef.errorVisible&&objRef.toggleMode!='hide_only'){objRef.objects.show();objRef.errorVisible=true;}};this.hide=function(subject){if(objRef.errorVisible&&objRef.toggleMode!='show_only'){objRef.objects.hide();objRef.errorVisible=false;}};};jFF.behaviours.FilterChars=function(options){var objRef=this;this.active=false;this.jField=options[0];this.filters=options[1];this.jField.bind('keyup.jFF',function(event){if(!objRef.active)return;var text=objRef.jField.val();if(objRef.filters.forEach)
var filtered=text.filtered.apply(text,objRef.filters);else
var filtered=text.filtered(objRef.filters);objRef.jField.val(filtered);});this.start=function(){objRef.active=true;return objRef;};this.stop=function(){objRef.active=false;return objRef;};this.start();};jFF.behaviours.FilteredReplicator=function(options){var objRef=this;this.active=false;this.jField=options[0];this.jDestination=options[1];this.filters=options[2];this.jField.bind('keyup.jFF',function(event){if(!objRef.active)return;var text=objRef.jField.val();if(objRef.filters.forEach)
var filtered=text.filtered.apply(text,objRef.filters);else
var filtered=text.filtered(objRef.filters);objRef.jDestination.val(filtered);objRef.jDestination.trigger('keyup');});this.start=function(){objRef.active=true;return objRef;};this.stop=function(){objRef.active=false;return objRef;};this.start();};jFF.behaviours.MaxChars=function(options){var objRef=this;this.active=false;this.jField=options[0];this.max=options[1];this.jField.bind('keyup.jFF',function(event){if(!objRef.active)return;var text=objRef.jField.val();if(text.length>objRef.max-1){text=text.substring(0,objRef.max);objRef.jField.val(text);}});this.start=function(){objRef.active=true;return objRef;};this.stop=function(){objRef.active=false;return objRef;};this.start();};jFF.behaviours.MaxChecked=function(options){var objRef=this;this.active=false;this.jField=options[0];this.max=options[1];this.checkedBoxes=0;this.checks=this.jField.filter(':checkbox').add(this.jField.find(':checkbox'));this.checks.bind('click.jFF',function(event){if(!objRef.active)return;var checkbox=event.target;objRef.checkedBoxes=objRef.checks.filter(':checked').length;if(objRef.checkedBoxes>objRef.max){checkbox.checked=false;}});this.start=function(){objRef.active=true;return objRef;};this.stop=function(){objRef.active=false;return objRef;};this.start();};jFF.behaviours.Replicator=function(options){var objRef=this;this.active=false;this.jField=options[0];this.jDestination=options[1];this.jField.bind('keyup.jFF',function(event){if(!objRef.active)return;var text=objRef.jField.val();objRef.jDestination.val(text);objRef.jDestination.trigger('keyup');});this.start=function(){objRef.active=true;return objRef;};this.stop=function(){objRef.active=false;return objRef;};this.start();};jFF.behaviours.MaxSelected=function(options){var objRef=this;this.active=false;this.jField=options[0];this.max=options[1];this.selectedOptions=0;this.options=this.jField.filter('option').add(this.jField.find('option'));this.options.bind('click.jFF',function(event){if(!objRef.active)return;var option=event.target;objRef.selectedOptions=objRef.options.filter(':selected').length;if(objRef.selectedOptions>objRef.max){option.selected=false;}});this.start=function(){objRef.active=true;return objRef;};this.stop=function(){objRef.active=false;return objRef;};this.start();};jFF.behaviours.CheckMonitor=function(options){var objRef=this;this.active=false;this.jField=options[0];this.checks=this.jField.filter(':checkbox').add(this.jField.find(':checkbox'));this.listeners=new Array();this.checked=null;this.trackerContainer=null;this.checkedContentCallback=null;this.uncheckerCallback=null;this.trackersWrapper=null;this.checks.bind('click.jFF',function(event){if(!objRef.active)return;objRef.notify();});this.reset=function(){objRef.checked=objRef.checks.filter(':checked');return objRef;};this.none=function(){objRef.checks.each(function(){this.checked=false;});objRef.notify();return objRef;};this.all=function(){objRef.checks.each(function(){this.checked=true;});objRef.notify();return objRef;};this.invert=function(){objRef.checks.each(function(){this.checked=!this.checked;});objRef.notify();return objRef;};this.notify=function(){if(!objRef.active)return;objRef.reset();objRef.listeners.forEach(function(listener){listener(objRef.checked);});if(objRef.checkedContentCallback){objRef.trackerContainer.html('');objRef.checked.each(function(){var currentChecked=$(this);var tracker=$(objRef.checkedContentCallback(currentChecked));objRef.trackerContainer.append(tracker);var unchecker=objRef.uncheckerCallback(tracker);unchecker.bind('click.jFF',function(event){event.preventDefault();currentChecked.attr('checked',false);objRef.notify();});});if(objRef.trackersWrapper){objRef.trackerContainer.contents().wrapAll(objRef.trackersWrapper);}}
return objRef;};this.listener=function(listener){objRef.listeners.push(listener);return objRef;};this.tracker=function(jContainer,checkedContentCallback,uncheckerCallback,trackersWrapper){objRef.checkedContentCallback=checkedContentCallback;objRef.uncheckerCallback=uncheckerCallback;objRef.trackerContainer=jContainer;objRef.trackersWrapper=trackersWrapper;return objRef;};this.start=function(){objRef.active=true;return objRef;};this.stop=function(){objRef.active=false;return objRef;};this.start();};jFF.behaviours.SelectMonitor=function(options){var objRef=this;this.active=false;this.jField=options[0];this.selects=this.jField.filter('option').add(this.jField.find('option'));this.listeners=new Array();this.selected=null;this.trackerContainer=null;this.selectedContentCallback=null;this.unselecterCallback=null;this.trackersWrapper=null;this.selects.bind('click.jFF',function(event){if(!objRef.active)return;objRef.notify();});this.reset=function(){objRef.selected=objRef.selects.filter(':selected');return objRef;};this.none=function(){objRef.selects.each(function(){this.selected=false;});objRef.notify();return objRef;};this.all=function(){objRef.selects.each(function(){this.selected=true;});objRef.notify();return objRef;};this.invert=function(){objRef.selects.each(function(){this.selected=!this.selected;});objRef.notify();return objRef;};this.notify=function(){if(!objRef.active)return;objRef.reset();objRef.listeners.forEach(function(listener){listener(objRef.selected);});if(objRef.selectedContentCallback){objRef.trackerContainer.html('');objRef.selected.each(function(){var currentSelected=$(this);var tracker=$(objRef.selectedContentCallback(currentSelected));objRef.trackerContainer.append(tracker);var unselecter=objRef.unselecterCallback(tracker);unselecter.bind('click.jFF',function(event){event.preventDefault();currentSelected.attr('selected',false);objRef.notify();});});if(objRef.trackersWrapper){objRef.trackerContainer.contents().wrapAll(objRef.trackersWrapper);}}
return objRef;};this.listener=function(listener){objRef.listeners.push(listener);return objRef;};this.tracker=function(jContainer,selectedContentCallback,unselecterCallback,trackersWrapper){objRef.selectedContentCallback=selectedContentCallback;objRef.unselecterCallback=unselecterCallback;objRef.trackerContainer=jContainer;objRef.trackersWrapper=trackersWrapper;return objRef;};this.start=function(){objRef.active=true;return objRef;};this.stop=function(){objRef.active=false;return objRef;};this.start();};jFF.behaviours.CharMonitor=function(options){var objRef=this;this.active=false;this.jField=options[0];this.inputs=this.jField.filter(':text,textarea,:password,:hidden').add(this.jField.find(':text,textarea,:password,:hidden'));this.listeners=new Array();this.chars=null;this.inputs.bind('keyup.jFF',function(event){if(!objRef.active)return;objRef.notify();});this.reset=function(){objRef.chars='';objRef.inputs.each(function(){objRef.chars+=$(this).val();});return objRef;};this.notify=function(){if(!objRef.active)return;objRef.reset();objRef.listeners.forEach(function(listener){listener(objRef.chars);});return objRef;};this.listener=function(listener){objRef.listeners.push(listener);return objRef;};this.start=function(){objRef.active=true;return objRef;};this.stop=function(){objRef.active=false;return objRef;};this.start();};})(jQuery);